<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPROUT - P2P Marketplace</title>
    <style>
      * {
        padding: 0;
        margin: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
        font-weight: bold;
        font-size: 14px;
      }

      button {
        cursor: pointer;
      }

      /* Header/Navigation Styles */
      .header {
        padding: 15px 30px;
        border-bottom: 1px solid rgb(235, 235, 235);
        display: flex;
        justify-content: space-between;
        gap: 20px;
        align-items: center;
        background-color: #f8f9fa;
      }

      .header div {
        padding: 0px 10px 10px 0px;
      }

      .logo {
        flex-grow: 0.25;
        text-align: center;
        cursor: pointer;
      }

      .search {
        flex-grow: 2;
      }

      .search input {
        width: 100%;
        padding: 10px 16px;
        border: none;
        border-radius: 9999px;
        background-color: #f2f2f2;
        color: #333;
        font-size: 14px;
        outline: none;
      }

      .search input::placeholder {
        color: #666;
      }

      .location {
        flex-grow: 0.5;
        position: relative;
      }

      .location button {
        width: 100%;
        padding: 10px 16px;
        border: none;
        border-radius: 9999px;
        background-color: #f2f2f2;
        color: #333;
        outline: none;
        font-size: 14px;
      }

      /* Location Dropdown */
      .location-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        padding: 15px;
        display: none;
      }

      .location-dropdown input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      .map-container {
        width: 100%;
        height: 200px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
      }

      .map-pin {
        position: absolute;
        font-size: 24px;
        color: #15733f;
        transition: all 0.3s ease;
      }

      .inbox {
        width: 50px;
        height: 50px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #fff;
        cursor: pointer;
      }

      .saved button,
      .cart button {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #15733f;
        border-radius: 9999px;
        background-color: #ffffff;
        color: #15733f;
        font-size: 14px;
      }

      .cart button {
        background-color: #15733f;
        color: #ffffff;
        border: none;
      }

      /* Page System */
      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      /* Content Layout */
      .content {
        padding: 15px;
        display: flex;
        gap: 20px;
        height: 100%;
      }

      .sidebar {
        flex: 0 0 250px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        border-right: 1px solid rgb(235, 235, 235);
        padding: 10px 20px;
      }

      .sidebar button {
        padding: 10px 20px;
        border: none;
        background-color: white;
        text-align: left;
        border: 1px solid gray;
        border-radius: 9999px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .sidebar button.filter {
        background-color: #15733f;
        color: white;
      }

      .content-main {
        padding: 10px 30px;
        flex-grow: 2;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .content-main h1 {
        font-size: 24px;
      }

      .all-cards {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
      }

      /* Card Styles */
      .card {
        background-color: #fff;
        border-radius: 12px;
        width: 225px;
        padding: 0px;
        text-align: left;
        transition: transform 0.2s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card img {
        width: 100%;
        border-radius: 10px;
        margin-bottom: 15px;
      }

      .card h3.product-name {
        margin: 10px 10px 5px 10px;
        color: #333;
      }

      .card p {
        font-size: 14px;
        color: #555;
        margin: 4px 10px;
      }

      .price {
        display: flex;
        gap: 10px;
        margin: 10px;
      }

      .seller-info {
        display: flex;
        gap: 10px;
        align-items: center;
        margin: 10px;
      }

      .image-container {
        position: relative;
        width: 100%;
        aspect-ratio: 3/4;
        object-fit: cover;
      }

      .image-container img {
        width: 100%;
        border-radius: 10px;
        display: block;
      }

      .image-container button {
        position: absolute;
        right: 10px;
        width: 35px;
        height: 35px;
        border: none;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.85);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: background-color 0.2s;
        z-index: 10;
      }

      .bookmark-btn {
        top: 10px;
      }

      .cart-btn {
        top: 55px;
      }

      .image-container button:hover {
        background-color: rgba(255, 255, 255, 1);
      }

      /* Product Detail Modal */
      .product-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      .modal-content {
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 80%;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
      }

      .modal-product-info {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }

      .modal-product-image {
        flex: 1;
      }

      .modal-product-image img {
        width: 100%;
        border-radius: 10px;
      }

      .modal-product-details {
        flex: 1;
      }

      .modal-product-details h2 {
        font-size: 20px;
        margin-bottom: 10px;
      }

      .seller-profile {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .seller-profile-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
      }

      .seller-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #ddd;
      }

      /* Quantity Controls */
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px;
      }

      .quantity-controls input {
        width: 60px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }

      /* Checkout Styles */
      .checkout-total {
        font-weight: bold;
        margin-top: 1rem;
        font-size: 1.2rem;
        text-align: center;
      }

      .checkout-actions {
        display: flex;
        justify-content: center;
        margin: 20px 0;
        gap: 10px;
      }

      .action-button {
        margin: 5px;
        padding: 12px 24px;
        background: #15733f;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      .action-button:hover {
        background: #0f5a32;
      }

      .action-button.secondary {
        background: #f2f2f2;
        color: #333;
        border: 1px solid #ccc;
      }

      /* Cart Badge */
      .cart-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: red;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .cart {
        position: relative;
      }

      /* Search Results */
      #search-results {
        min-height: 200px;
      }

      /* Payment Form */
      .payment-form {
        max-width: 500px;
        margin: 20px auto;
      }

      .payment-form input,
      .payment-form select {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
      }

      /* Inbox Styles */
      .inbox-container {
        display: flex;
        height: calc(100vh - 80px);
      }

      .chat-sidebar {
        width: 300px;
        border-right: 1px solid #ddd;
        display: flex;
        flex-direction: column;
      }

      .chat-list {
        flex: 1;
        overflow-y: auto;
      }

      .chat-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chat-item:hover {
        background: #f5f5f5;
      }

      .chat-item.active {
        background: #e8f5e8;
      }

      .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ddd;
      }

      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .chat-header {
        padding: 15px;
        border-bottom: 1px solid #ddd;
        background: #f8f9fa;
      }

      .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f9f9f9;
      }

      .message {
        margin-bottom: 15px;
        max-width: 70%;
      }

      .message.sent {
        margin-left: auto;
        text-align: right;
      }

      .message-bubble {
        background: white;
        padding: 10px 15px;
        border-radius: 18px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .message.sent .message-bubble {
        background: #15733f;
        color: white;
      }

      .chat-input {
        padding: 15px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
      }

      .chat-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
      }

      .send-btn {
        background: #15733f;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="logo" onclick="showPage('home')">
        <p>S P R O U T</p>
      </div>
      <div class="search">
        <input type="text" id="search-bar" placeholder="Search Sprout" />
      </div>
      <div class="location">
        <button onclick="toggleLocationDropdown()">Location</button>
        <div class="location-dropdown" id="location-dropdown">
          <input
            type="text"
            placeholder="Enter your address..."
            id="address-input"
          />
          <div class="map-container" onclick="movePin(event)">
            <span>📍 Click to set your location</span>
            <div class="map-pin" id="map-pin" style="top: 50%; left: 50%">
              📍
            </div>
          </div>
          <button
            class="action-button"
            style="width: 100%; margin-top: 10px"
            onclick="saveLocation()"
          >
            Save Location
          </button>
        </div>
      </div>
      <div class="inbox" onclick="showPage('inbox')">
        <span style="font-size: 24px">📧</span>
      </div>
      <div class="saved">
        <button onclick="showPage('wishlist')">Saved</button>
      </div>
      <div class="cart">
        <button onclick="showPage('cart')">Cart</button>
        <span class="cart-badge" id="cart-badge" style="display: none">0</span>
      </div>
    </div>

    <!-- Home Page -->
    <div id="home" class="page active">
      <div class="content">
        <div class="sidebar">
          <button class="filter">Filter</button>
          <button onclick="filterByCategory('all')">All</button>
          <button onclick="filterByCategory('Vegetables')">Vegetables</button>
          <button onclick="filterByCategory('Fruit')">Fruits</button>
          <button onclick="filterByCategory('Dairy')">Dairy</button>
          <button onclick="filterByCategory('Nuts')">Nuts</button>
          <button onclick="filterByCategory('Preserves')">Preserves</button>
          <button onclick="filterByCategory('Spices')">Spices</button>
          <button onclick="filterByCategory('Beverages')">Beverages</button>
        </div>
        <div class="content-main">
          <div>
            <h1>Popular Deals</h1>
          </div>
          <div class="all-cards" id="product-list">
            <!-- Products will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Search Results Page -->
    <div id="search" class="page">
      <div class="content">
        <div class="content-main">
          <div>
            <h1>Search Results</h1>
          </div>
          <div class="all-cards" id="search-results">
            <!-- Search results will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Page -->
    <div id="cart" class="page">
      <div class="content">
        <div class="content-main">
          <div>
            <h1>Your Shopping Cart</h1>
          </div>
          <div class="all-cards" id="cart-list">
            <!-- Cart items will be rendered here -->
          </div>
          <div class="checkout-actions">
            <button class="action-button" onclick="showPage('checkout')">
              Proceed to Checkout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Wishlist Page -->
    <div id="wishlist" class="page">
      <div class="content">
        <div class="content-main">
          <div>
            <h1>Saved for Later</h1>
          </div>
          <div class="all-cards" id="wishlist-list">
            <!-- Wishlist items will be rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Checkout Page -->
    <div id="checkout" class="page">
      <div class="content">
        <div class="content-main">
          <div>
            <h1>Checkout</h1>
          </div>
          <div class="all-cards" id="checkout-list">
            <!-- Checkout items will be rendered here -->
          </div>
          <p class="checkout-total" id="checkout-total"></p>
          <div class="checkout-actions">
            <button class="action-button" onclick="showPage('payment')">
              Proceed to Payment
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Page -->
    <div id="payment" class="page">
      <div class="content">
        <div class="content-main">
          <div>
            <h1>Payment Details</h1>
          </div>
          <div class="payment-form">
            <form onsubmit="processPayment(event)">
              <input type="text" placeholder="Full Name" required />
              <input type="text" placeholder="Address" required />
              <input type="email" placeholder="Email" required />
              <select required>
                <option value="">Select Payment Method</option>
                <option value="credit">Credit Card</option>
                <option value="paypal">PayPal</option>
                <option value="bank">Bank Transfer</option>
              </select>
              <div class="checkout-actions">
                <button type="submit" class="action-button">
                  Submit Payment
                </button>
                <button
                  type="button"
                  class="action-button secondary"
                  onclick="showPage('checkout')"
                >
                  Back to Checkout
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Inbox Page -->
    <div id="inbox" class="page">
      <div class="inbox-container">
        <div class="chat-sidebar">
          <div style="padding: 15px; border-bottom: 1px solid #ddd">
            <h2>Messages</h2>
          </div>
          <div class="chat-list" id="chat-list">
            <!-- Chat contacts will be rendered here -->
          </div>
        </div>
        <div class="chat-main" id="chat-main">
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: center;
              height: 100%;
              color: #666;
            "
          >
            Select a conversation to start messaging
          </div>
        </div>
      </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-modal" class="product-modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Product Details</h2>
          <button class="close-btn" onclick="closeProductModal()">
            &times;
          </button>
        </div>
        <div id="modal-body">
          <!-- Product details will be inserted here -->
        </div>
      </div>
    </div>

    <script>
      // Products data
      const products = [
        {
          id: 1,
          name: "Baby organic carrots",
          category: "Vegetables",
          price: 6.0,
          unitPrice: 1.2,
          weight: "500g",
          stock: 25,
          description:
            "Fresh organic baby carrots, perfect for snacking or cooking. Grown locally without pesticides.",
          image: "product-img/carrot.jpg",
          rating: 4.0,
          seller: "Hannah S.",
          sellerImage: "https://via.placeholder.com/50/FF6B35/FFFFFF?text=H",
          sellerRating: 4.8,
          sellerReviews: 127,
        },
        {
          id: 2,
          name: "Homemade granola with cinnamon",
          category: "Preserves",
          price: 6.0,
          unitPrice: 6.2,
          weight: "300g",
          stock: 15,
          description:
            "Handcrafted granola with organic oats, nuts, and Ceylon cinnamon. Perfect for breakfast.",
          image: "product-img/granola.jpg",
          rating: 3.5,
          seller: "Laurel P.",
          sellerImage: "https://via.placeholder.com/50/F7931E/FFFFFF?text=L",
          sellerRating: 4.2,
          sellerReviews: 89,
        },
        {
          id: 3,
          name: "Fresh blackpepper",
          category: "Spices",
          price: 8.0,
          unitPrice: 4.5,
          weight: "100g",
          stock: 30,
          description:
            "Premium black pepper, freshly ground. Adds perfect heat and flavor to your dishes.",
          image: "product-img/black pepper.jpg",
          rating: 4.5,
          seller: "Emma K.",
          sellerImage: "https://via.placeholder.com/50/C1272D/FFFFFF?text=E",
          sellerRating: 4.6,
          sellerReviews: 203,
        },
        {
          id: 4,
          name: "Orange",
          category: "Fruit",
          price: 5.5,
          unitPrice: 5.5,
          weight: "1kg",
          stock: 40,
          description:
            "Sweet and juicy oranges, perfect for fresh juice or snacking. Rich in vitamin C.",
          image: "product-img/orange.jpg",
          rating: 4.2,
          seller: "Farm Co.",
          sellerImage: "https://via.placeholder.com/50/4CAF50/FFFFFF?text=F",
          sellerRating: 4.9,
          sellerReviews: 456,
        },
        {
          id: 5,
          name: "Cashew",
          category: "Nuts",
          price: 12.0,
          unitPrice: 3.0,
          weight: "250g",
          stock: 18,
          description:
            "Premium roasted cashews, perfect for snacking or cooking. Rich in healthy fats.",
          image: "product-img/cashew.jpg",
          rating: 4.8,
          seller: "Nut Farm",
          sellerImage: "https://via.placeholder.com/50/8BC34A/FFFFFF?text=N",
          sellerRating: 4.7,
          sellerReviews: 178,
        },
        {
          id: 6,
          name: "Potato",
          category: "Vegetables",
          price: 8.5,
          unitPrice: 8.5,
          weight: "2kg",
          stock: 50,
          description:
            "Fresh organic potatoes, perfect for roasting, mashing, or frying. Locally grown.",
          image: "product-img/potato.jpg",
          rating: 4.6,
          seller: "Spice Co.",
          sellerImage: "https://via.placeholder.com/50/795548/FFFFFF?text=S",
          sellerRating: 4.4,
          sellerReviews: 234,
        },
      ];

      let cart = [];
      let wishlist = [];
      let currentFilter = "all";
      let chats = {};
      let activeChat = null;

      // Initialize chats with sellers
      function initializeChats() {
        const sellers = [...new Set(products.map((p) => p.seller))];
        sellers.forEach((seller) => {
          const product = products.find((p) => p.seller === seller);
          chats[seller] = {
            name: seller,
            avatar: product.sellerImage,
            messages: [],
          };
        });
      }

      // Location functionality
      function toggleLocationDropdown() {
        const dropdown = document.getElementById("location-dropdown");
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      }

      function movePin(event) {
        const container = event.currentTarget;
        const rect = container.getBoundingClientRect();
        const pin = document.getElementById("map-pin");

        const x = ((event.clientX - rect.left) / rect.width) * 100;
        const y = ((event.clientY - rect.top) / rect.height) * 100;

        pin.style.left = x + "%";
        pin.style.top = y + "%";
      }

      function saveLocation() {
        const address = document.getElementById("address-input").value;
        if (address) {
          document.querySelector(".location button").textContent =
            address.substring(0, 15) + "...";
        }
        toggleLocationDropdown();
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
        if (!event.target.closest(".location")) {
          document.getElementById("location-dropdown").style.display = "none";
        }
      });

      // Page navigation
      function showPage(pageId) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById(pageId).classList.add("active");

        if (pageId === "cart") renderCart();
        if (pageId === "wishlist") renderWishlist();
        if (pageId === "checkout") renderCheckout();
        if (pageId === "inbox") renderInbox();
      }

      // Product modal functions
      function openProductModal(productId) {
        const product = products.find((p) => p.id === productId);
        const modal = document.getElementById("product-modal");
        const modalBody = document.getElementById("modal-body");

        modalBody.innerHTML = `
          <div class="modal-product-info">
            <div class="modal-product-image">
              <img src="${product.image}" alt="${product.name}">
            </div>
            <div class="modal-product-details">
              <h2>${product.name}</h2>
              <div class="price">
                <p class="price-kilo">A$${product.price.toFixed(2)}/kg</p>
                <p class="price-unit">A$${product.unitPrice.toFixed(2)} ea</p>
              </div>
              <p><strong>Weight:</strong> ${product.weight}</p>
              <p><strong>Stock:</strong> ${product.stock} available</p>
              <p><strong>Rating:</strong> ${product.rating} ★</p>
              <p><strong>Description:</strong> ${product.description}</p>
              
              <div class="quantity-controls" style="margin: 15px 0;">
                <label>Quantity: <input type="number" min="1" max="${
                  product.stock
                }" value="1" id="modal-qty-${product.id}"></label>
              </div>
              
              <div class="checkout-actions">
                <button class="action-button" onclick="addToCart(${
                  product.id
                }, true)">Add to Cart</button>
                <button class="action-button secondary" onclick="toggleWishlist(${
                  product.id
                })">
                  ${
                    wishlist.some((item) => item.id === product.id)
                      ? "Remove from Wishlist"
                      : "Add to Wishlist"
                  }
                </button>
              </div>
            </div>
          </div>
          
          <div class="seller-profile">
            <div class="seller-profile-header">
              <img src="${product.sellerImage}" alt="${
          product.seller
        }" class="seller-avatar">
              <div>
                <h3>${product.seller}</h3>
                <p>${product.sellerRating} ★ (${
          product.sellerReviews
        } reviews)</p>
              </div>
            </div>
            <div class="checkout-actions">
              <button class="action-button" onclick="startChat('${
                product.seller
              }')">Chat with Seller</button>
            </div>
          </div>
        `;

        modal.style.display = "flex";
      }

      function closeProductModal() {
        document.getElementById("product-modal").style.display = "none";
      }

      // Create product card
      function createCard(product, page) {
        const isInWishlist = wishlist.some((item) => item.id === product.id);
        const wishlistIcon = isInWishlist ? "❤️" : "🔖";

        let quantityControls = "";
        let actionButtons = "";

        if (page === "home" || page === "search") {
          quantityControls = `
          <div class="quantity-controls">
            <label>Qty: <input type="number" min="1" value="1" id="qty-${product.id}"></label>
          </div>
        `;
        } else if (page === "checkout") {
          quantityControls = `
          <div class="quantity-controls">
            <label>Qty: 
              <input type="range" min="0" max="20" value="${product.quantity}" 
                     onchange="updateQuantity(${product.id}, this.value)">
              ${product.quantity}
            </label>
          </div>
        `;
        } else if (page === "cart") {
          actionButtons = `
          <div style="text-align: center; margin: 10px;">
            <button class="action-button secondary" onclick="removeFromCart(${product.id})">Remove</button>
          </div>
        `;
        } else if (page === "wishlist") {
          actionButtons = `
          <div style="text-align: center; margin: 10px;">
            <button class="action-button secondary" onclick="removeFromWishlist(${product.id})">Remove</button>
          </div>
        `;
        }

        return `
        <div class="card" onclick="${
          page === "home" || page === "search"
            ? `openProductModal(${product.id})`
            : ""
        }">
          <div class="image-container">
            <img src="${product.image}" alt="${product.name}">
            ${
              page === "home" || page === "search"
                ? `
              <button class="bookmark-btn" onclick="event.stopPropagation(); toggleWishlist(${product.id})">${wishlistIcon}</button>
              <button class="cart-btn" onclick="event.stopPropagation(); addToCart(${product.id})">🛒</button>
            `
                : ""
            }
          </div>
          <h3 class="product-name">${product.name}</h3>
          <div class="price">
            <p class="price-kilo">A${product.price.toFixed(2)}/kg</p>
            <p class="price-unit">A${product.unitPrice.toFixed(2)} ea</p>
          </div>
          <div class="seller-info">
            <p class="rating">${product.rating} ★</p>
            <p class="seller-name">Sold by ${product.seller}</p>
          </div>
          ${quantityControls}
          ${actionButtons}
        </div>
      `;
      }

      // Render products
      function renderProducts(productsToRender = products) {
        let filteredProducts = productsToRender;
        if (currentFilter !== "all") {
          filteredProducts = productsToRender.filter(
            (p) => p.category === currentFilter
          );
        }
        document.getElementById("product-list").innerHTML = filteredProducts
          .map((p) => createCard(p, "home"))
          .join("");
      }

      // Search functionality
      document
        .getElementById("search-bar")
        .addEventListener("input", function () {
          const keyword = this.value.toLowerCase().trim();

          if (keyword === "") {
            showPage("home");
            return;
          }

          const results = products.filter(
            (p) =>
              p.name.toLowerCase().includes(keyword) ||
              p.category.toLowerCase().includes(keyword)
          );

          document.getElementById("search-results").innerHTML = results
            .map((p) => createCard(p, "search"))
            .join("");

          if (document.querySelector(".page.active").id !== "search") {
            showPage("search");
          }
        });

      // Filter functionality
      function filterByCategory(category) {
        currentFilter = category;
        renderProducts();

        // Update filter button styles
        document.querySelectorAll(".sidebar button").forEach((btn) => {
          btn.classList.remove("filter");
        });
        event.target.classList.add("filter");
      }

      // Cart functionality
      function addToCart(id, fromModal = false) {
        const qtyElement = fromModal
          ? document.getElementById(`modal-qty-${id}`)
          : document.getElementById(`qty-${id}`);
        const qty = qtyElement ? parseInt(qtyElement.value) || 1 : 1;
        const product = products.find((p) => p.id === id);
        const existing = cart.find((item) => item.id === id);

        if (existing) {
          existing.quantity += qty;
        } else {
          cart.push({ ...product, quantity: qty });
        }

        updateCartBadge();
        alert(`${product.name} added to cart!`);

        if (fromModal) {
          closeProductModal();
        }
      }

      function renderCart() {
        document.getElementById("cart-list").innerHTML = cart
          .map((p) => createCard(p, "cart"))
          .join("");
      }

      function removeFromCart(id) {
        cart = cart.filter((item) => item.id !== id);
        renderCart();
        updateCartBadge();
      }

      // Wishlist functionality
      function toggleWishlist(id) {
        const product = products.find((p) => p.id === id);
        const existingIndex = wishlist.findIndex((item) => item.id === id);

        if (existingIndex >= 0) {
          wishlist.splice(existingIndex, 1);
          alert(`${product.name} removed from wishlist!`);
        } else {
          wishlist.push(product);
          alert(`${product.name} added to wishlist!`);
        }

        // Re-render current page to update wishlist icons
        if (document.querySelector(".page.active").id === "home") {
          renderProducts();
        }
      }

      function renderWishlist() {
        document.getElementById("wishlist-list").innerHTML = wishlist
          .map((p) => createCard(p, "wishlist"))
          .join("");
      }

      function removeFromWishlist(id) {
        wishlist = wishlist.filter((item) => item.id !== id);
        renderWishlist();
      }

      // Checkout functionality
      function renderCheckout() {
        document.getElementById("checkout-list").innerHTML = cart
          .map((p) => createCard(p, "checkout"))
          .join("");
        const total = cart.reduce(
          (sum, item) => sum + item.price * item.quantity,
          0
        );
        document.getElementById(
          "checkout-total"
        ).innerText = `Total: A${total.toFixed(2)}`;
      }

      function updateQuantity(id, newQty) {
        const item = cart.find((p) => p.id === id);
        if (item) {
          item.quantity = parseInt(newQty);
          if (item.quantity === 0) {
            removeFromCart(id);
          }
          renderCheckout();
          updateCartBadge();
        }
      }

      // Cart badge
      function updateCartBadge() {
        const badge = document.getElementById("cart-badge");
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

        if (totalItems > 0) {
          badge.textContent = totalItems;
          badge.style.display = "flex";
        } else {
          badge.style.display = "none";
        }
      }

      // Inbox functionality
      function renderInbox() {
        const chatList = document.getElementById("chat-list");
        chatList.innerHTML = Object.keys(chats)
          .map(
            (seller) => `
          <div class="chat-item ${
            activeChat === seller ? "active" : ""
          }" onclick="openChat('${seller}')">
            <img src="${
              chats[seller].avatar
            }" alt="${seller}" class="chat-avatar">
            <div>
              <strong>${seller}</strong>
              <p style="color: #666; font-size: 12px;">
                ${
                  chats[seller].messages.length > 0
                    ? chats[seller].messages[
                        chats[seller].messages.length - 1
                      ].text.substring(0, 30) + "..."
                    : "No messages yet"
                }
              </p>
            </div>
          </div>
        `
          )
          .join("");
      }

      function openChat(seller) {
        activeChat = seller;
        renderInbox();

        const chatMain = document.getElementById("chat-main");
        chatMain.innerHTML = `
          <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
              <img src="${
                chats[seller].avatar
              }" alt="${seller}" class="chat-avatar" style="width: 30px; height: 30px;">
              <strong>${seller}</strong>
            </div>
          </div>
          <div class="chat-messages" id="chat-messages-${seller}">
            ${chats[seller].messages
              .map(
                (msg) => `
              <div class="message ${msg.sender === "me" ? "sent" : ""}">
                <div class="message-bubble">
                  ${msg.text}
                  <div style="font-size: 11px; color: ${
                    msg.sender === "me" ? "rgba(255,255,255,0.7)" : "#999"
                  }; margin-top: 5px;">
                    ${msg.time}
                  </div>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
          <div class="chat-input">
            <input type="text" placeholder="Type a message..." id="message-input-${seller}" onkeypress="handleMessageSend(event, '${seller}')">
            <button class="send-btn" onclick="sendMessage('${seller}')">➤</button>
          </div>
        `;

        // Scroll to bottom
        setTimeout(() => {
          const messagesDiv = document.getElementById(
            `chat-messages-${seller}`
          );
          if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
        }, 100);
      }

      function startChat(seller) {
        closeProductModal();
        showPage("inbox");
        setTimeout(() => openChat(seller), 100);
      }

      function handleMessageSend(event, seller) {
        if (event.key === "Enter") {
          sendMessage(seller);
        }
      }

      function sendMessage(seller) {
        const input = document.getElementById(`message-input-${seller}`);
        const message = input.value.trim();

        if (message) {
          const now = new Date();
          const time = now.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
          });

          chats[seller].messages.push({
            text: message,
            sender: "me",
            time: time,
          });

          input.value = "";
          openChat(seller);

          // Simulate seller response
          setTimeout(() => {
            const responses = [
              "Thanks for your message! I'll get back to you soon.",
              "Hi there! How can I help you with this product?",
              "Great question! Let me check that for you.",
              "Thanks for your interest! The product is fresh and ready.",
              "Hello! I'm here to help with any questions about my products.",
            ];

            chats[seller].messages.push({
              text: responses[Math.floor(Math.random() * responses.length)],
              sender: seller,
              time: new Date().toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              }),
            });

            if (activeChat === seller) {
              openChat(seller);
            }
          }, 2000);
        }
      }

      // Payment processing
      function processPayment(event) {
        event.preventDefault();
        alert("Payment processed successfully! Thank you for your order.");
        cart = [];
        updateCartBadge();
        showPage("home");
      }

      // Initialize
      initializeChats();
      renderProducts();
    </script>
  </body>
</html>
